#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "ğŸ” Running pre-commit checks..."

# Check if we're in a Git repository
if [ ! -d .git ]; then
  echo "âŒ Not in a Git repository"
  exit 1
fi

# Get list of staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -z "$STAGED_FILES" ]; then
  echo "â„¹ï¸  No staged files to check"
  exit 0
fi

echo "ğŸ“ Checking $(echo "$STAGED_FILES" | wc -l) staged files..."

# Check for Ruby files
RUBY_FILES=$(echo "$STAGED_FILES" | grep -E '\.(rb|rake)$' || true)
if [ -n "$RUBY_FILES" ]; then
  echo "ğŸ”´ Checking Ruby files with RuboCop..."
  if ! bundle exec rubocop $RUBY_FILES; then
    echo "âŒ RuboCop failed. Run 'bundle exec rubocop -a' to auto-fix issues."
    exit 1
  fi
  echo "âœ… RuboCop passed"
fi

# Check for JavaScript/Vue files
JS_VUE_FILES=$(echo "$STAGED_FILES" | grep -E '\.(js|vue|ts)$' || true)
if [ -n "$JS_VUE_FILES" ]; then
  echo "ğŸŸ¡ Checking JavaScript/Vue files with ESLint..."
  if ! pnpm eslint $JS_VUE_FILES; then
    echo "âŒ ESLint failed. Run 'pnpm eslint:fix' to auto-fix issues."
    exit 1
  fi
  echo "âœ… ESLint passed"
fi

# Check for secrets and sensitive information
echo "ğŸ”’ Checking for secrets..."
SECRETS_FOUND=false

# Check for common secret patterns
for file in $STAGED_FILES; do
  if [ -f "$file" ]; then
    # Check for various secret patterns
    if grep -qE "(password|secret|key|token|api_key)" "$file" | grep -qE "(=|:)\s*['\"]?[a-zA-Z0-9]{20,}"; then
      echo "âš ï¸  Possible secret found in $file"
      SECRETS_FOUND=true
    fi
    
    # Check for AWS keys
    if grep -qE "AKIA[0-9A-Z]{16}" "$file"; then
      echo "âš ï¸  AWS Access Key found in $file"
      SECRETS_FOUND=true
    fi
    
    # Check for database URLs with credentials
    if grep -qE "://[^:]+:[^@]+@" "$file"; then
      echo "âš ï¸  Database URL with credentials found in $file"
      SECRETS_FOUND=true
    fi
  fi
done

if [ "$SECRETS_FOUND" = true ]; then
  echo "âŒ Potential secrets found in staged files"
  echo "ğŸ’¡ Review the files and remove any sensitive information"
  exit 1
fi

# Check for debugging code
echo "ğŸ› Checking for debugging code..."
DEBUG_FOUND=false

for file in $STAGED_FILES; do
  if [ -f "$file" ]; then
    # Check for common debug statements
    if grep -qE "(console\.log|debugger|binding\.pry|byebug|puts|p [^a])" "$file"; then
      echo "âš ï¸  Debug statement found in $file"
      DEBUG_FOUND=true
    fi
  fi
done

if [ "$DEBUG_FOUND" = true ]; then
  echo "âš ï¸  Debug statements found in staged files"
  echo "ğŸ’¡ Consider removing debug statements before committing"
  echo "ğŸ¤” Continue anyway? (y/n)"
  read -r response
  if [ "$response" != "y" ] && [ "$response" != "Y" ]; then
    exit 1
  fi
fi

# Check for large files
echo "ğŸ“ Checking file sizes..."
LARGE_FILES=$(echo "$STAGED_FILES" | xargs ls -la 2>/dev/null | awk '$5 > 1048576 {print $9, $5}' || true)
if [ -n "$LARGE_FILES" ]; then
  echo "âš ï¸  Large files detected (>1MB):"
  echo "$LARGE_FILES"
  echo "ğŸ’¡ Consider using Git LFS for large files"
  echo "ğŸ¤” Continue anyway? (y/n)"
  read -r response
  if [ "$response" != "y" ] && [ "$response" != "Y" ]; then
    exit 1
  fi
fi

# Check for merge conflict markers
echo "ğŸ”€ Checking for merge conflict markers..."
for file in $STAGED_FILES; do
  if [ -f "$file" ] && grep -qE "^(<<<<<<<|=======|>>>>>>>)" "$file"; then
    echo "âŒ Merge conflict markers found in $file"
    exit 1
  fi
done

echo "âœ… All pre-commit checks passed!"
echo "ğŸš€ Ready to commit!"