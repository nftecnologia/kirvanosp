#!/bin/bash

# Quick Fix Performance Script
# Applies all performance optimizations immediately

echo "ğŸš€ KIRVANO PERFORMANCE QUICK FIX"
echo "================================"
echo ""
echo "This script applies immediate performance optimizations to resolve"
echo "the 4+ minute loading issue by switching to local services."
echo ""

# Check if Docker is available
if ! command -v docker &> /dev/null; then
    echo "âŒ Docker is required but not installed. Please install Docker first."
    echo "   https://docs.docker.com/get-docker/"
    exit 1
fi

# Check if Docker is running
if ! docker info > /dev/null 2>&1; then
    echo "âŒ Docker is not running. Please start Docker Desktop first."
    exit 1
fi

echo "âœ… Docker is available and running"
echo ""

# Step 1: Start local services
echo "ğŸ“¦ Step 1: Starting local PostgreSQL and Redis services..."
docker-compose up -d db redis

if [ $? -ne 0 ]; then
    echo "âŒ Failed to start Docker services"
    exit 1
fi

echo "âœ… Local services started"
echo ""

# Step 2: Wait for services to be ready
echo "â³ Step 2: Waiting for services to be ready (10 seconds)..."
sleep 10

# Step 3: Switch configuration
echo "ğŸ”§ Step 3: Switching to local configuration..."
if [ -f ".env.local" ]; then
    # Backup current config
    cp .env .env.railway.backup
    cp .env.local .env
    echo "âœ… Configuration switched to local services"
else
    echo "âŒ .env.local file not found - this should not happen"
    exit 1
fi

# Step 4: Enable caching
echo "ğŸ”„ Step 4: Enabling development caching..."
touch tmp/caching-dev.txt
echo "âœ… Development caching enabled"

# Step 5: Create/migrate database if needed
echo "ğŸ˜ Step 5: Setting up local database..."
if bundle exec rails db:create db:migrate > /dev/null 2>&1; then
    echo "âœ… Database setup complete"
else
    echo "âš ï¸  Database setup had issues, but continuing..."
fi

# Step 6: Test connections
echo "ğŸ” Step 6: Testing connections..."
echo ""

echo "  Testing PostgreSQL..."
if timeout 10 bundle exec rails runner "ActiveRecord::Base.connection.execute('SELECT 1')" > /dev/null 2>&1; then
    echo "  âœ… PostgreSQL connection successful"
else
    echo "  âš ï¸  PostgreSQL connection slow or failed"
fi

echo "  Testing Redis..."
if timeout 5 bundle exec rails runner "Rails.cache.redis.ping" > /dev/null 2>&1; then
    echo "  âœ… Redis connection successful"
else
    echo "  âš ï¸  Redis connection failed (may work after server restart)"
fi

echo ""
echo "ğŸ‰ QUICK FIX COMPLETE!"
echo "====================="
echo ""
echo "Performance optimizations applied:"
echo "  âœ“ Local PostgreSQL (instead of Railway cloud)"
echo "  âœ“ Local Redis (instead of Railway cloud)"
echo "  âœ“ Database timeout reduced to 5 seconds"
echo "  âœ“ HTTP request timeout set to 15 seconds"
echo "  âœ“ Development caching enabled"
echo "  âœ“ Asset debug mode disabled"
echo "  âœ“ Request timeout middleware configured"
echo ""
echo "ğŸš€ NEXT STEPS:"
echo "1. Restart your Rails server:"
echo "   pnpm dev"
echo "   OR"
echo "   overmind start -f ./Procfile.dev"
echo ""
echo "2. Your application should now load much faster!"
echo ""
echo "ğŸ“Š To monitor performance:"
echo "   ./bin/performance-check"
echo ""
echo "ğŸ”„ To revert to Railway services:"
echo "   ./bin/switch-to-railway"
echo ""
echo "ğŸ’¡ The loading time should improve from 4+ minutes to under 30 seconds."