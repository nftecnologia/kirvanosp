#!/bin/bash

# Quick Fix Script: Switch to Local Development Services
# This script switches from Railway cloud services to local services for faster performance

echo "ğŸš€ Switching to local development services for better performance..."

# Check if Docker is running
if ! docker info > /dev/null 2>&1; then
    echo "âŒ Docker is not running. Please start Docker first."
    exit 1
fi

# Start local services if not already running
echo "ğŸ“¦ Starting local PostgreSQL and Redis services..."
docker-compose up -d db redis

# Wait for services to be ready
echo "â³ Waiting for services to be ready..."
sleep 5

# Switch to local configuration
if [ -f ".env.local" ]; then
    cp .env .env.railway.backup
    cp .env.local .env
    echo "âœ… Switched to local configuration"
else
    echo "âŒ .env.local file not found"
    exit 1
fi

# Enable development caching
touch tmp/caching-dev.txt
echo "âœ… Enabled development caching"

# Check if local PostgreSQL is accessible
echo "ğŸ” Testing local database connection..."
if bundle exec rails runner "ActiveRecord::Base.connection.execute('SELECT 1')" > /dev/null 2>&1; then
    echo "âœ… Local database connection successful"
else
    echo "âš ï¸  Database connection test failed. You may need to create the database:"
    echo "   bundle exec rails db:create db:migrate"
fi

# Check if local Redis is accessible
echo "ğŸ” Testing local Redis connection..."
if bundle exec rails runner "Rails.cache.redis.ping" > /dev/null 2>&1; then
    echo "âœ… Local Redis connection successful"
else
    echo "âš ï¸  Redis connection test failed. Check if Redis is running on port 6379"
fi

echo ""
echo "ğŸ‰ Local development setup complete!"
echo ""
echo "Performance optimizations applied:"
echo "  âœ“ Local PostgreSQL (faster than Railway)"
echo "  âœ“ Local Redis (faster than Railway)"
echo "  âœ“ Reduced database timeouts (5s instead of 14s)"
echo "  âœ“ HTTP request timeouts (15s instead of no limit)"
echo "  âœ“ Development caching enabled"
echo "  âœ“ Asset debug mode disabled for faster loading"
echo ""
echo "To revert to Railway services, run: bin/switch-to-railway"
echo ""
echo "Now restart your Rails server:"
echo "  pnpm dev"
echo "  or"
echo "  overmind start -f ./Procfile.dev"